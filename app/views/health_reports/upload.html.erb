<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="ä¸Šä¼ å¥åº·æŠ¥å‘Š - æ”¯æŒå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ">
  <meta name="theme-color" content="#8A2BE2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
  <title>ä¸Šä¼ å¥åº·æŠ¥å‘Š - Health Wise</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* è®¾è®¡ç³»ç»Ÿå˜é‡ */
    :root {
      /* ä¸»è‰²è°ƒ */
      --primary-blue: #667eea;
      --secondary-purple: #764ba2;
      --accent-teal: #06b6d4;
      --accent-emerald: #10b981;
      --accent-rose: #f43f5e;
      --accent-amber: #f59e0b;

      /* çŠ¶æ€é¢œè‰² */
      --success: #10b981;
      --warning: #f59e0b;
      --error: #f43f5e;
      --info: #06b6d4;

      /* èƒŒæ™¯è‰² */
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --bg-glass: rgba(255, 255, 255, 0.1);

      /* æ–‡å­—é¢œè‰² */
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --text-light: rgba(255, 255, 255, 0.9);

      /* è¾¹æ¡†é¢œè‰² */
      --border-primary: #e2e8f0;
      --border-secondary: #cbd5e1;
      --border-glass: rgba(255, 255, 255, 0.18);

      /* é˜´å½± */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* åœ†è§’ */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* é—´è· */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;

      /* åŠ¨ç”» */
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 350ms ease;

      /* å®‰å…¨åŒºåŸŸ */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-tertiary: #94a3b8;
        --border-primary: #334155;
        --border-secondary: #475569;
      }
    }

    /* å…¨å±€æ ·å¼ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-purple) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
    }

    /* èƒŒæ™¯åŠ¨ç”» */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.25) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.15) 0%, transparent 60%);
      animation: breathe 12s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes breathe {
      0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0.9; transform: scale(1.02) rotate(1deg); }
    }

    /* ä¸»å®¹å™¨ */
    .upload-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-lg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* å¤´éƒ¨ */
    .upload-header {
      text-align: center;
      margin-bottom: var(--space-2xl);
    }

    .upload-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: var(--space-sm);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .upload-subtitle {
      font-size: 1.125rem;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 400;
    }

    /* ä¸Šä¼ å¡ç‰‡ */
    .upload-card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      box-shadow: var(--shadow-xl);
      transition: var(--transition-normal);
    }

    .upload-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    /* æ‹–æ‹½åŒºåŸŸ */
    .drop-zone {
      border: 2px dashed var(--border-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      text-align: center;
      transition: var(--transition-normal);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .drop-zone:hover {
      border-color: var(--accent-teal);
      background: rgba(6, 182, 212, 0.05);
    }

    .drop-zone.drag-over {
      border-color: var(--accent-teal);
      background: rgba(6, 182, 212, 0.1);
      transform: scale(1.02);
    }

    .drop-zone.uploading {
      border-color: var(--accent-emerald);
      background: rgba(16, 185, 129, 0.1);
      cursor: not-allowed;
    }

    .drop-zone-content {
      pointer-events: none;
    }

    .drop-zone-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-md);
      background: linear-gradient(135deg, var(--accent-teal), var(--accent-emerald));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      transition: var(--transition-normal);
    }

    .drop-zone:hover .drop-zone-icon {
      transform: scale(1.1);
    }

    .drop-zone-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .drop-zone-description {
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
    }

    .drop-zone-hint {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }

    /* æ–‡ä»¶è¾“å…¥ */
    .file-input {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .file-input:disabled {
      cursor: not-allowed;
    }

    /* æ–‡ä»¶ä¿¡æ¯ */
    .file-info {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      margin-top: var(--space-md);
      display: none;
    }

    .file-info.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .file-info-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }

    .file-info-icon {
      width: 24px;
      height: 24px;
      color: var(--primary-blue);
    }

    .file-info-details {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .file-size {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .file-remove {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: var(--space-xs);
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }

    .file-remove:hover {
      color: var(--error);
      background: rgba(244, 63, 94, 0.1);
    }

    /* æŠ¥å‘Šç±»å‹é€‰æ‹© */
    .report-type-section {
      margin-top: var(--space-lg);
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .report-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-sm);
    }

    .report-type-option {
      position: relative;
    }

    .report-type-input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .report-type-label {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: var(--transition-fast);
      background: var(--bg-primary);
    }

    .report-type-input:checked + .report-type-label {
      border-color: var(--accent-teal);
      background: rgba(6, 182, 212, 0.05);
    }

    .report-type-label:hover {
      border-color: var(--accent-teal);
      transform: translateY(-1px);
    }

    .report-type-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .report-type-gene {
      background: linear-gradient(135deg, var(--accent-emerald), #059669);
      color: white;
    }

    .report-type-protein {
      background: linear-gradient(135deg, var(--accent-teal), #0891b2);
      color: white;
    }

    .report-type-text {
      flex: 1;
    }

    .report-type-title {
      font-weight: 600;
      color: var(--text-primary);
      display: block;
    }

    .report-type-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* ä¸Šä¼ è¿›åº¦ */
    .upload-progress {
      margin-top: var(--space-lg);
      display: none;
    }

    .upload-progress.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .progress-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .progress-percentage {
      font-weight: 700;
      color: var(--accent-teal);
    }

    .progress-bar-container {
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      height: 8px;
      overflow: hidden;
      margin-bottom: var(--space-sm);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-teal), var(--accent-emerald));
      border-radius: var(--radius-full);
      transition: width var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .progress-speed {
      font-weight: 500;
    }

    .progress-time {
      font-weight: 500;
    }

    /* ä¸Šä¼ çŠ¶æ€ */
    .upload-status {
      margin-top: var(--space-lg);
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      text-align: center;
      display: none;
    }

    .upload-status.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .upload-status.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .upload-status.error {
      background: rgba(244, 63, 94, 0.1);
      border: 1px solid rgba(244, 63, 94, 0.2);
      color: var(--error);
    }

    .upload-status-icon {
      width: 24px;
      height: 24px;
      margin: 0 auto var(--space-sm);
    }

    /* æ“ä½œæŒ‰é’® */
    .upload-actions {
      margin-top: var(--space-xl);
      display: flex;
      gap: var(--space-md);
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition-normal);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 48px;
      position: relative;
      overflow: hidden;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-teal), var(--accent-emerald));
      color: white;
      box-shadow: 0 4px 14px 0 rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(6, 182, 212, 0.4);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-secondary);
      border: 2px solid var(--border-primary);
    }

    .btn-secondary:hover:not(:disabled) {
      border-color: var(--accent-teal);
      color: var(--accent-teal);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* æŒ‰é’®åŠ è½½çŠ¶æ€ */
    .btn-loading {
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é”™è¯¯æç¤º */
    .error-message {
      background: rgba(244, 63, 94, 0.1);
      border: 1px solid rgba(244, 63, 94, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      margin-top: var(--space-md);
      display: none;
    }

    .error-message.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .error-icon {
      width: 20px;
      height: 20px;
      color: var(--error);
      margin-right: 8px;
      flex-shrink: 0;
    }

    .error-content {
      display: flex;
      align-items: flex-start;
    }

    .error-text {
      color: var(--error);
      font-weight: 500;
    }

    /* å¸®åŠ©ä¿¡æ¯ */
    .help-section {
      margin-top: var(--space-xl);
      padding: var(--space-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-primary);
    }

    .help-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .help-list {
      list-style: none;
      color: var(--text-secondary);
    }

    .help-item {
      padding: var(--space-xs) 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .help-item::before {
      content: 'â€¢';
      color: var(--accent-teal);
      font-weight: bold;
      flex-shrink: 0;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .upload-container {
        padding: var(--space-md);
      }

      .upload-title {
        font-size: 2rem;
      }

      .upload-card {
        padding: var(--space-lg);
      }

      .drop-zone {
        padding: var(--space-lg);
      }

      .report-type-grid {
        grid-template-columns: 1fr;
      }

      .upload-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .upload-title {
        font-size: 1.75rem;
      }

      .upload-subtitle {
        font-size: 1rem;
      }

      .drop-zone-title {
        font-size: 1.125rem;
      }
    }

    /* åŠ¨ç”»ä¼˜åŒ– */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* æ— éšœç¢æ”¯æŒ */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ç„¦ç‚¹æ ·å¼ */
    .btn:focus-visible,
    .file-input:focus-visible,
    .report-type-input:focus-visible + .report-type-label {
      outline: 2px solid var(--accent-teal);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="upload-container">
    <!-- å¤´éƒ¨ -->
    <header class="upload-header">
      <h1 class="upload-title">ä¸Šä¼ å¥åº·æŠ¥å‘Š</h1>
      <p class="upload-subtitle">æ”¯æŒå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ï¼Œæœ€å¤§æ”¯æŒ 500MB PDF æ–‡ä»¶</p>
    </header>

    <!-- ä¸Šä¼ å¡ç‰‡ -->
    <main class="upload-card">
      <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
      <div class="drop-zone" id="dropZone">
        <input 
          type="file" 
          id="fileInput" 
          class="file-input" 
          accept=".pdf,application/pdf" 
          aria-label="é€‰æ‹©PDFæ–‡ä»¶"
        >
        <div class="drop-zone-content">
          <div class="drop-zone-icon">ğŸ“„</div>
          <h3 class="drop-zone-title">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h3>
          <p class="drop-zone-description">æ”¯æŒ PDF æ ¼å¼ï¼Œæœ€å¤§ 500MB</p>
          <p class="drop-zone-hint">æ¨èä½¿ç”¨ Chromeã€Firefoxã€Safari æµè§ˆå™¨</p>
        </div>
      </div>

      <!-- æ–‡ä»¶ä¿¡æ¯ -->
      <div class="file-info" id="fileInfo">
        <div class="file-info-header">
          <svg class="file-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <div class="file-info-details">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
          </div>
          <button type="button" class="file-remove" id="fileRemove" aria-label="ç§»é™¤æ–‡ä»¶">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>

      <!-- é”™è¯¯ä¿¡æ¯ -->
      <div class="error-message" id="errorMessage">
        <div class="error-content">
          <svg class="error-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <div class="error-text" id="errorText"></div>
        </div>
      </div>

      <!-- æŠ¥å‘Šç±»å‹é€‰æ‹© -->
      <section class="report-type-section">
        <h2 class="section-title">é€‰æ‹©æŠ¥å‘Šç±»å‹</h2>
        <div class="report-type-grid">
          <div class="report-type-option">
            <input type="radio" id="geneReport" name="reportType" value="åŸºå› æ£€æŸ¥æŠ¥å‘Š" class="report-type-input">
            <label for="geneReport" class="report-type-label">
              <div class="report-type-icon report-type-gene">ğŸ§¬</div>
              <div class="report-type-text">
                <span class="report-type-title">åŸºå› æ£€æŸ¥æŠ¥å‘Š</span>
                <span class="report-type-description">åŸºå› æ£€æµ‹åˆ†æç»“æœ</span>
              </div>
            </label>
          </div>
          <div class="report-type-option">
            <input type="radio" id="proteinReport" name="reportType" value="è›‹ç™½è´¨æ£€æµ‹æŠ¥å‘Š" class="report-type-input">
            <label for="proteinReport" class="report-type-label">
              <div class="report-type-icon report-type-protein">ğŸ§ª</div>
              <div class="report-type-text">
                <span class="report-type-title">è›‹ç™½è´¨æ£€æµ‹æŠ¥å‘Š</span>
                <span class="report-type-description">è›‹ç™½è´¨æŒ‡æ ‡æ£€æŸ¥ç»“æœ</span>
              </div>
            </label>
          </div>
        </div>
      </section>

      <!-- ä¸Šä¼ è¿›åº¦ -->
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-header">
          <span class="progress-title">ä¸Šä¼ è¿›åº¦</span>
          <span class="progress-percentage" id="progressPercentage">0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="progress-details">
          <span class="progress-speed" id="progressSpeed">0 KB/s</span>
          <span class="progress-time" id="progressTime">å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...</span>
        </div>
      </div>

      <!-- ä¸Šä¼ çŠ¶æ€ -->
      <div class="upload-status" id="uploadStatus">
        <svg class="upload-status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <div id="statusText"></div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="upload-actions">
        <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="window.history.back()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          è¿”å›
        </button>
        <button type="button" class="btn btn-primary" id="uploadBtn" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          å¼€å§‹ä¸Šä¼ 
        </button>
      </div>

      <!-- å¸®åŠ©ä¿¡æ¯ -->
      <section class="help-section">
        <h3 class="help-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          ä¸Šä¼ é¡»çŸ¥
        </h3>
        <ul class="help-list">
          <li class="help-item">æ”¯æŒ PDF æ ¼å¼æ–‡ä»¶ï¼Œæœ€å¤§æ”¯æŒ 500MB</li>
          <li class="help-item">ä¸Šä¼ è¿‡ç¨‹ä¸­è¯·å‹¿å…³é—­é¡µé¢æˆ–åˆ·æ–°æµè§ˆå™¨</li>
          <li class="help-item">å»ºè®®ä½¿ç”¨ç¨³å®šçš„ç½‘ç»œè¿æ¥è¿›è¡Œä¸Šä¼ </li>
          <li class="help-item">æ–‡ä»¶ä¸Šä¼ åä¼šè‡ªåŠ¨è¿›è¡Œç—…æ¯’æ‰«æå’Œæ ¼å¼éªŒè¯</li>
          <li class="help-item">ä¸Šä¼ å®Œæˆåå¯åœ¨å¥åº·æŠ¥å‘Šåˆ—è¡¨ä¸­æŸ¥çœ‹</li>
        </ul>
      </section>
    </main>
  </div>

  <script>
    // ä¸Šä¼ ç®¡ç†å™¨
    class UploadManager {
      constructor() {
        this.dropZone = document.getElementById('dropZone');
        this.fileInput = document.getElementById('fileInput');
        this.fileInfo = document.getElementById('fileInfo');
        this.fileName = document.getElementById('fileName');
        this.fileSize = document.getElementById('fileSize');
        this.fileRemove = document.getElementById('fileRemove');
        this.errorMessage = document.getElementById('errorMessage');
        this.errorText = document.getElementById('errorText');
        this.uploadProgress = document.getElementById('uploadProgress');
        this.progressBar = document.getElementById('progressBar');
        this.progressPercentage = document.getElementById('progressPercentage');
        this.progressSpeed = document.getElementById('progressSpeed');
        this.progressTime = document.getElementById('progressTime');
        this.uploadStatus = document.getElementById('uploadStatus');
        this.statusText = document.getElementById('statusText');
        this.uploadBtn = document.getElementById('uploadBtn');
        this.cancelBtn = document.getElementById('cancelBtn');
        
        this.selectedFile = null;
        this.isUploading = false;
        this.uploadStartTime = null;
        this.uploadedBytes = 0;
        
        this.init();
      }

      init() {
        this.setupDragAndDrop();
        this.setupFileInput();
        this.setupButtons();
        this.setupReportTypeSelection();
      }

      setupDragAndDrop() {
        // æ‹–æ‹½è¿›å…¥
        this.dropZone.addEventListener('dragenter', (e) => {
          e.preventDefault();
          this.dropZone.classList.add('drag-over');
        });

        // æ‹–æ‹½æ‚¬åœ
        this.dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          this.dropZone.classList.add('drag-over');
        });

        // æ‹–æ‹½ç¦»å¼€
        this.dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          this.dropZone.classList.remove('drag-over');
        });

        // æ”¾ç½®æ–‡ä»¶
        this.dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          this.dropZone.classList.remove('drag-over');
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            this.handleFileSelection(files[0]);
          }
        });
      }

      setupFileInput() {
        this.fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            this.handleFileSelection(e.target.files[0]);
          }
        });
      }

      setupButtons() {
        this.fileRemove.addEventListener('click', () => {
          this.clearFile();
        });

        this.uploadBtn.addEventListener('click', () => {
          this.startUpload();
        });
      }

      setupReportTypeSelection() {
        const reportTypeInputs = document.querySelectorAll('input[name="reportType"]');
        reportTypeInputs.forEach(input => {
          input.addEventListener('change', () => {
            this.validateForm();
          });
        });
      }

      handleFileSelection(file) {
        this.hideError();
        
        // éªŒè¯æ–‡ä»¶
        const validation = this.validateFile(file);
        if (!validation.valid) {
          this.showError(validation.message);
          return;
        }

        this.selectedFile = file;
        this.displayFileInfo(file);
        this.validateForm();
      }

      validateFile(file) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
          return { valid: false, message: 'è¯·é€‰æ‹© PDF æ ¼å¼çš„æ–‡ä»¶' };
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        const maxSize = 500 * 1024 * 1024; // 500MB
        if (file.size > maxSize) {
          const sizeMB = (file.size / 1024 / 1024).toFixed(2);
          return { valid: false, message: `æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§ 500MBï¼‰ï¼Œå½“å‰æ–‡ä»¶å¤§å°ï¼š${sizeMB} MB` };
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if (file.size === 0) {
          return { valid: false, message: 'æ–‡ä»¶ä¸ºç©ºï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶' };
        }

        return { valid: true };
      }

      displayFileInfo(file) {
        this.fileName.textContent = file.name;
        this.fileSize.textContent = this.formatFileSize(file.size);
        this.fileInfo.classList.add('show');
      }

      clearFile() {
        this.selectedFile = null;
        this.fileInput.value = '';
        this.fileInfo.classList.remove('show');
        this.validateForm();
        this.hideError();
      }

      validateForm() {
        const hasFile = this.selectedFile !== null;
        const hasReportType = document.querySelector('input[name="reportType"]:checked') !== null;
        
        this.uploadBtn.disabled = !hasFile || !hasReportType || this.isUploading;
      }

      showError(message) {
        this.errorText.textContent = message;
        this.errorMessage.classList.add('show');
      }

      hideError() {
        this.errorMessage.classList.remove('show');
      }

      async startUpload() {
        if (!this.selectedFile || this.isUploading) return;

        const reportType = document.querySelector('input[name="reportType"]:checked')?.value;
        if (!reportType) {
          this.showError('è¯·é€‰æ‹©æŠ¥å‘Šç±»å‹');
          return;
        }

        this.isUploading = true;
        this.uploadStartTime = Date.now();
        this.uploadedBytes = 0;

        // æ›´æ–°UIçŠ¶æ€
        this.setUploadingState(true);
        this.hideError();
        this.showProgress();

        try {
          // ä½¿ç”¨åˆ†å—ä¸Šä¼ 
          await this.uploadFileChunked(this.selectedFile, reportType);
        } catch (error) {
          console.error('ä¸Šä¼ å¤±è´¥:', error);
          this.showError(error.message || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          this.hideProgress();
        } finally {
          this.isUploading = false;
          this.setUploadingState(false);
        }
      }

      async uploadFileChunked(file, reportType) {
        const chunkSize = 1 * 1024 * 1024; // 1MB åˆ†å—
        const totalChunks = Math.ceil(file.size / chunkSize);
        
        console.log(`å¼€å§‹åˆ†å—ä¸Šä¼ : ${totalChunks} ä¸ªåˆ†å—, æ€»å¤§å°: ${this.formatFileSize(file.size)}`);

        for (let i = 0; i < totalChunks; i++) {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append('file', chunk, file.name);
          formData.append('report_type', reportType);
          formData.append('chunk_index', i);
          formData.append('total_chunks', totalChunks);
          formData.append('file_size', file.size);
          formData.append('file_name', file.name);

          try {
            const response = await fetch('/health_reports/upload_chunked', {
              method: 'POST',
              headers: {
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
              },
              body: formData
            });

            if (!response.ok) {
              throw new Error(`ä¸Šä¼ å¤±è´¥: HTTP ${response.status}`);
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
            }

            // æ›´æ–°è¿›åº¦
            this.uploadedBytes = end;
            this.updateProgress();

            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆ†å—
            if (i === totalChunks - 1) {
              this.showSuccess(result.message || 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
              
              // å»¶è¿Ÿåè·³è½¬åˆ°æŠ¥å‘Šåˆ—è¡¨
              setTimeout(() => {
                window.location.href = '/health_reports';
              }, 2000);
            }
          } catch (error) {
            console.error(`åˆ†å— ${i + 1}/${totalChunks} ä¸Šä¼ å¤±è´¥:`, error);
            throw new Error(`ä¸Šä¼ ä¸­æ–­: ${error.message}`);
          }
        }
      }

      updateProgress() {
        if (!this.selectedFile || !this.uploadStartTime) return;

        const progress = (this.uploadedBytes / this.selectedFile.size) * 100;
        const elapsedTime = (Date.now() - this.uploadStartTime) / 1000;
        const speed = this.uploadedBytes / elapsedTime;
        const remainingBytes = this.selectedFile.size - this.uploadedBytes;
        const remainingTime = remainingBytes / speed;

        this.progressBar.style.width = `${progress}%`;
        this.progressPercentage.textContent = `${progress.toFixed(1)}%`;
        this.progressSpeed.textContent = `${this.formatFileSize(speed)}/s`;
        this.progressTime.textContent = `å‰©ä½™æ—¶é—´: ${this.formatTime(remainingTime)}`;
      }

      showProgress() {
        this.uploadProgress.classList.add('show');
        this.updateProgress();
      }

      hideProgress() {
        this.uploadProgress.classList.remove('show');
      }

      showSuccess(message) {
        this.statusText.textContent = message;
        this.uploadStatus.className = 'upload-status show success';
        this.uploadStatus.querySelector('.upload-status-icon').innerHTML = 
          '<polyline points="20 6 9 17 4 12"></polyline>';
      }

      showStatus(message, type = 'info') {
        this.statusText.textContent = message;
        this.uploadStatus.className = `upload-status show ${type}`;
        
        if (type === 'error') {
          this.uploadStatus.querySelector('.upload-status-icon').innerHTML = 
            '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
        }
      }

      setUploadingState(isUploading) {
        this.dropZone.classList.toggle('uploading', isUploading);
        this.fileInput.disabled = isUploading;
        this.uploadBtn.disabled = isUploading || !this.selectedFile;
        
        if (isUploading) {
          this.uploadBtn.classList.add('btn-loading');
          this.uploadBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            ä¸Šä¼ ä¸­...
          `;
        } else {
          this.uploadBtn.classList.remove('btn-loading');
          this.uploadBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            å¼€å§‹ä¸Šä¼ 
          `;
        }
      }

      formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      formatTime(seconds) {
        if (seconds < 60) return `${Math.ceil(seconds)}ç§’`;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.ceil(seconds % 60);
        return `${minutes}åˆ†${remainingSeconds}ç§’`;
      }
    }

    // åˆå§‹åŒ–ä¸Šä¼ ç®¡ç†å™¨
    document.addEventListener('DOMContentLoaded', () => {
      new UploadManager();
      
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
      setTimeout(() => {
        const status = document.getElementById('uploadStatus');
        const statusText = document.getElementById('statusText');
        statusText.textContent = 'ç³»ç»Ÿå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä¸Šä¼ æ–‡ä»¶';
        status.className = 'upload-status show info';
        status.querySelector('.upload-status-icon').innerHTML = 
          '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>';
        
        setTimeout(() => {
          status.classList.remove('show');
        }, 3000);
      }, 1000);
    });

    // é˜²æ­¢é¡µé¢æ„å¤–å…³é—­
    window.addEventListener('beforeunload', (e) => {
      const uploadManager = window.uploadManager;
      if (uploadManager && uploadManager.isUploading) {
        e.preventDefault();
        e.returnValue = 'æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>