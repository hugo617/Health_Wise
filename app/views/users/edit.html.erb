<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑用户 - <%= @user.nickname %> - 烯晞数字健康档案系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #667eea;
            --secondary-purple: #764ba2;
            --accent-teal: #06b6d4;
            --accent-emerald: #10b981;
            --accent-rose: #f43f5e;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.18);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .content-header h1 {
            font-size: 1.75rem;
            color: white;
            margin: 0;
            font-weight: 600;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
            color: white;
            border-bottom: none;
            border-radius: 1rem 1rem 0 0 !important;
            font-weight: 600;
            padding: 1.25rem 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(156, 163, 175, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-rose), #dc2626);
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.4);
        }
        
        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-rose);
        }
        
        .invalid-feedback {
            display: block;
            font-size: 0.875rem;
            color: var(--accent-rose);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .toast {
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .info-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .info-value {
            font-weight: 500;
            color: #111827;
        }
    </style>
</head>
<body>
    <!-- Toast 通知 -->
    <div class="toast-container">
        <div class="toast" id="notificationToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                操作成功完成！
            </div>
        </div>
    </div>

    <!-- 页面标题和操作按钮 -->
    <div class="content-header">
        <h1><i class="fas fa-user-edit me-3"></i>编辑用户 - <%= @user.nickname %></h1>
        <div>
            <%= link_to user_path(@user), class: "btn btn-secondary me-2" do %>
                <i class="fas fa-arrow-left me-2"></i>返回详情
            <% end %>
            <%= button_to user_path(@user), 
                method: :delete, 
                class: "btn btn-danger",
                onclick: "return confirm('确定要删除该用户吗？此操作不可撤销。')",
                data: { confirm: "确定要删除用户 #{@user.nickname} 吗？" } do %>
                <i class="fas fa-trash me-2"></i>删除用户
            <% end %>
        </div>
    </div>

    <div class="row">
        <!-- 左侧用户信息 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user me-2"></i>当前用户信息
                </div>
                <div class="card-body">
                    <div class="info-card">
                        <div class="info-item">
                            <span class="info-label">用户ID</span>
                            <span class="info-value">#<%= @user.id %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">手机号</span>
                            <span class="info-value"><%= @user.phone_number %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">当前昵称</span>
                            <span class="info-value"><%= @user.nickname %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">当前邮箱</span>
                            <span class="info-value"><%= @user.email %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">创建时间</span>
                            <span class="info-value"><%= @user.created_at.strftime('%Y-%m-%d') %></span>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>提示：</strong>手机号不可修改，如需修改请联系管理员。
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧编辑表单 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-edit me-2"></i>编辑用户信息
                </div>
                <div class="card-body">
                    <%= form_with model: @user, local: true, html: { id: 'editUserForm', novalidate: true } do |f| %>
                        <% if @user.errors.any? %>
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <h5 class="alert-heading">
                                    <i class="fas fa-exclamation-triangle me-2"></i>表单验证失败
                                </h5>
                                <ul class="mb-0">
                                    <% @user.errors.full_messages.each do |message| %>
                                        <li><%= message %></li>
                                    <% end %>
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        <% end %>

                        <div class="row">
                            <!-- 左侧基本信息 -->
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5 class="form-section-title">
                                        <i class="fas fa-id-card me-2"></i>基本信息
                                    </h5>
                                    
                                    <div class="mb-3">
                                        <%= f.label :nickname, "昵称", class: "form-label required" %>
                                        <%= f.text_field :nickname, 
                                            class: "form-control #{'is-invalid' if @user.errors[:nickname].any?}",
                                            placeholder: "请输入用户昵称",
                                            maxlength: 50,
                                            required: true %>
                                        <% if @user.errors[:nickname].any? %>
                                            <div class="invalid-feedback">
                                                <%= @user.errors[:nickname].join(', ') %>
                                            </div>
                                        <% end %>
                                        <small class="form-text text-muted">最多50个字符</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <%= f.label :email, "邮箱", class: "form-label required" %>
                                        <%= f.email_field :email, 
                                            class: "form-control #{'is-invalid' if @user.errors[:email].any?}",
                                            placeholder: "请输入邮箱地址",
                                            required: true %>
                                        <% if @user.errors[:email].any? %>
                                            <div class="invalid-feedback">
                                                <%= @user.errors[:email].join(', ') %>
                                            </div>
                                        <% end %>
                                        <small class="form-text text-muted">请输入有效的邮箱地址</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧账户设置 -->
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5 class="form-section-title">
                                        <i class="fas fa-cog me-2"></i>账户设置
                                    </h5>
                                    
                                    <div class="mb-3">
                                        <%= f.label :password, "新密码", class: "form-label" %>
                                        <%= f.password_field :password, 
                                            class: "form-control #{'is-invalid' if @user.errors[:password].any?}",
                                            placeholder: "留空则不修改密码",
                                            minlength: 6 %>
                                        <% if @user.errors[:password].any? %>
                                            <div class="invalid-feedback">
                                                <%= @user.errors[:password].join(', ') %>
                                            </div>
                                        <% end %>
                                        <small class="form-text text-muted">留空则保持原密码，修改需至少6个字符</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <%= f.label :role, "角色", class: "form-label" %>
                                        <%= f.select :role, 
                                            [['管理员', 'admin'], ['普通用户', 'user']], 
                                            {},
                                            class: "form-select" %>
                                        <small class="form-text text-muted">选择用户角色权限</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <%= f.label :status, "状态", class: "form-label" %>
                                        <%= f.select :status, 
                                            [['正常', 'active'], ['禁用', 'inactive'], ['暂停', 'suspended']], 
                                            {},
                                            class: "form-select" %>
                                        <small class="form-text text-muted">设置用户账户状态</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <%= f.label :membership_type, "会员类型", class: "form-label" %>
                                        <%= f.select :membership_type, 
                                            [['次卡会员', '次卡会员'], ['月卡会员', '月卡会员'], 
                                             ['年卡会员', '年卡会员'], ['其他会员类别', '其他会员类别']], 
                                            {},
                                            class: "form-select" %>
                                        <small class="form-text text-muted">选择会员类型</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <%= link_to user_path(@user), class: "btn btn-secondary" do %>
                                        <i class="fas fa-times me-2"></i>取消
                                    <% end %>
                                    <%= f.submit "保存更改", class: "btn btn-primary", id: "submitBtn" %>
                                </div>
                            </div>
                        </div>
                    <% end %>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 显示通知消息
        function showNotification(title, message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // 设置通知类型样式
            toast.className = 'toast';
            if (type === 'success') {
                toast.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toast.classList.add('bg-warning');
            } else if (type === 'info') {
                toast.classList.add('bg-info', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
        }

        // 表单验证增强
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('editUserForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // 邮箱实时验证
            const emailInput = document.getElementById('user_email');
            emailInput.addEventListener('input', function() {
                const email = this.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    this.classList.add('is-invalid');
                    this.setCustomValidity('邮箱格式不正确');
                } else {
                    this.classList.remove('is-invalid');
                    this.setCustomValidity('');
                }
            });
            
            // 密码强度提示
            const passwordInput = document.getElementById('user_password');
            if (passwordInput) {
                const passwordHelp = passwordInput.nextElementSibling;
                
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    if (!password) {
                        passwordHelp.textContent = '留空则保持原密码，修改需至少6个字符';
                        passwordHelp.className = 'form-text text-muted';
                        return;
                    }
                    
                    let strength = 0;
                    let message = '';
                    
                    if (password.length >= 6) strength++;
                    if (password.length >= 8) strength++;
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                    if (/\d/.test(password)) strength++;
                    if (/[^\w\s]/.test(password)) strength++;
                    
                    if (strength <= 2) {
                        message = '密码强度：弱';
                        passwordHelp.className = 'form-text text-danger';
                    } else if (strength <= 3) {
                        message = '密码强度：中等';
                        passwordHelp.className = 'form-text text-warning';
                    } else {
                        message = '密码强度：强';
                        passwordHelp.className = 'form-text text-success';
                    }
                    
                    passwordHelp.textContent = message;
                });
            }
            
            // 表单提交处理
            form.addEventListener('submit', function(e) {
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                    showNotification('错误', '请检查表单输入是否正确', 'error');
                } else {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';
                    submitBtn.disabled = true;
                }
                
                form.classList.add('was-validated');
            });
            
            // 检查是否有通知消息
            <% if flash[:notice] %>
                showNotification('成功', '<%= j flash[:notice] %>', 'success');
            <% end %>
            
            <% if flash[:alert] %>
                showNotification('错误', '<%= j flash[:alert] %>', 'error');
            <% end %>
        });
    </script>
</body>
</html>